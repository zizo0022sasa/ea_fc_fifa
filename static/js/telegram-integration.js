/**
 * ğŸ¤– Telegram Integration Module - FC 26 Profile Setup
 * Ù†Ø¸Ø§Ù… Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ù…Ø¹Ø²ÙˆÙ„ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ù„
 * 
 * @version 2.0.0
 * @author FC26 Team
 * @description ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø³ÙˆØ¯ Ù„ÙƒÙ„ Ù…Ø§ ÙŠØ®Øµ Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… - Ù„Ø§ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©
 */

// ğŸ”’ Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© (Private Variables)
let isProcessingTelegram = false;
let telegramProcessTimeout = null;
let telegramMonitoringInterval = null;

/**
 * ğŸš€ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ÙØµØ¯ÙÙ‘Ø±Ø© - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
 * Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù„Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
 */
export async function handleTelegramLink() {
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…...');
    
    const telegramBtn = document.getElementById('telegram-link-btn');
    if (!telegramBtn) {
        console.error('âŒ Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ (Ù†Ø³ØªÙˆØ±Ø¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)
    const validationStates = await getValidationStatesFromMainSystem();
    
    // Ø·Ø¨Ø§Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„ØªØ´Ø®ÙŠØµ
    console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', validationStates);
    
    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!validationStates.platform || !validationStates.whatsapp) {
        console.log('âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
        handleIncompleteDataError(telegramBtn);
        return;
    }
    
    console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©ØŒ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¨Ø·...');
    
    // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
    if (isProcessingTelegram) {
        showTelegramNotification('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...', 'warning');
        return;
    }
    
    isProcessingTelegram = true;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    updateTelegramButtonToLoading(telegramBtn);
    
    try {
        // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        const formData = await collectFormDataForTelegram();
        console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
            platform: formData.platform,
            whatsapp: formData.whatsapp.substring(0, 5) + '***',
            paymentMethod: formData.paymentMethod
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø®Ø§Ø¯Ù…
        const serverResponse = await sendTelegramLinkRequest(formData);
        
        if (serverResponse.success && serverResponse.telegram_web_url) {
            console.log('ğŸ”— Ù†Ø¬Ø­ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…:', serverResponse);
            
            // ÙØªØ­ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©
            await openTelegramSmartly(serverResponse);
            
            // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ
            displayCopyableCode(telegramBtn, serverResponse);
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¨Ø·
            startTelegramLinkingMonitor(serverResponse.telegram_code);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ù„Ù†Ø¬Ø§Ø­
            updateTelegramButtonToSuccess(telegramBtn);
            
        } else {
            throw new Error(serverResponse.message || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…');
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…:', error);
        handleTelegramError(telegramBtn, error.message);
        
    } finally {
        // ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        setTimeout(() => {
            isProcessingTelegram = false;
        }, 3000);
    }
}

/**
 * ğŸ“‹ Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
 */
// âœ…âœ…âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…âœ…âœ…
async function collectFormDataForTelegram() {
    const platform = document.getElementById('platform')?.value || '';
    const whatsapp = document.getElementById('whatsapp')?.value || '';
    const paymentMethod = document.getElementById('payment_method')?.value || '';
    const paymentDetails = getActivePaymentDetails();
    
    return {
        platform: platform,
        whatsapp: whatsapp, // <--- ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§
        payment_method: paymentMethod,
        payment_details: paymentDetails
    };
}


/**
 * ğŸ’³ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ø´Ø·Ø©
 */
function getActivePaymentDetails() {
    const paymentMethod = document.getElementById('payment_method')?.value || '';
    
    if (paymentMethod.includes('cash') || paymentMethod === 'bank_wallet') {
        return document.getElementById('mobile-number')?.value || '';
    } else if (paymentMethod === 'tilda') {
        return document.getElementById('card-number')?.value || '';
    } else if (paymentMethod === 'instapay') {
        return document.getElementById('payment-link')?.value || '';
    }
    
    return '';
}

/**
 * ğŸŒ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø®Ø§Ø¯Ù…
 */
async function sendTelegramLinkRequest(formData) {
    const response = await fetch('/generate-telegram-code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFTokenFromMainSystem()
        },
        body: JSON.stringify(formData)
    });
    
    if (!response.ok) {
        throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
    }
    
    return await response.json();
}

/**
 * ğŸ“± ÙØªØ­ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø°ÙƒÙŠØ©
 */
async function openTelegramSmartly(data) {
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    console.log('ğŸ“± ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²:', { isMobile, isIOS, isAndroid });
    
    if (isMobile) {
        // Ù„Ù„Ù‡ÙˆØ§ØªÙ: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹
        console.log('ğŸš€ Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…...');
        
        if (data.telegram_app_url) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù…Ø®ÙÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
            const appLink = document.createElement('a');
            appLink.href = data.telegram_app_url;
            appLink.style.display = 'none';
            document.body.appendChild(appLink);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            appLink.click();
            
            // ØªÙ†Ø¸ÙŠÙ
            setTimeout(() => {
                if (document.body.contains(appLink)) {
                    document.body.removeChild(appLink);
                }
            }, 100);
        }
        
        // Ø®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©: ÙØªØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        setTimeout(() => {
            console.log('ğŸŒ ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©...');
            window.open(data.telegram_web_url, '_blank');
        }, 2000);
        
    } else {
        // Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: ÙØªØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¨Ø§Ø´Ø±Ø©
        console.log('ğŸ’» ÙØªØ­ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­...');
        window.open(data.telegram_web_url, '_blank');
    }
    
    // Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
    setTimeout(() => {
        copyTelegramCodeToClipboard(data.telegram_code);
    }, 1500);
}

/**
 * ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ø³Ø®
 */
function displayCopyableCode(telegramBtn, data) {
    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø³Ø§Ø¨Ù‚
    const existingCodeDisplay = document.querySelector('.telegram-code-display');
    if (existingCodeDisplay) {
        existingCodeDisplay.remove();
    }
    
    const codeDisplay = document.createElement('div');
    codeDisplay.className = 'telegram-code-display';
    codeDisplay.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(0, 136, 204, 0.1), rgba(0, 85, 153, 0.15)); 
                    padding: 15px; margin: 15px 0; border-radius: 12px; text-align: center; 
                    border: 2px solid #0088cc; backdrop-filter: blur(10px);">
            <div style="color: #0088cc; font-weight: 700; margin-bottom: 10px;">
                <i class="fas fa-copy"></i> Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ:
            </div>
            <code style="background: white; padding: 8px 12px; border-radius: 6px; 
                         font-weight: bold; color: #0088cc; font-size: 1.1em; 
                         word-break: break-all; display: inline-block; margin-bottom: 10px;">
                /start ${data.telegram_code}
            </code>
            <div style="font-size: 0.9em; color: rgba(255, 255, 255, 0.8);">
                <small>Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
            </div>
            <button onclick="window.copyTelegramCodeManual('/start ${data.telegram_code}')" 
                    style="background: #0088cc; color: white; border: none; padding: 8px 16px; 
                           border-radius: 6px; margin-top: 10px; cursor: pointer; font-weight: 600;">
                ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
            </button>
        </div>
    `;
    
    // Ø¥Ø¯Ø±Ø§Ø¬ Ø¹Ù†ØµØ± Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
    telegramBtn.parentNode.insertBefore(codeDisplay, telegramBtn.nextSibling);
    
    // Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (codeDisplay && codeDisplay.parentNode) {
            codeDisplay.style.opacity = '0';
            setTimeout(() => {
                if (codeDisplay.parentNode) {
                    codeDisplay.remove();
                }
            }, 500);
        }
    }, 10000);
}

/**
 * ğŸ“‹ Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø­Ø§ÙØ¸Ø©
 */
function copyTelegramCodeToClipboard(code) {
    const fullCode = `/start ${code}`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(fullCode).then(() => {
            console.log('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø­Ø§ÙØ¸Ø©:', fullCode);
            showTelegramNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø­Ø§ÙØ¸Ø©! Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…', 'success');
        }).catch(err => {
            console.warn('âŒ ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯:', err);
            fallbackCopyToClipboard(fullCode);
        });
    } else {
        fallbackCopyToClipboard(fullCode);
    }
}

/**
 * ğŸ“‹ Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù†Ø³Ø®
 */
function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showTelegramNotification('ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©!', 'success');
        }
    } catch (err) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
    }
    
    document.body.removeChild(textArea);
}

/**
 * ğŸ‘ï¸ Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
 */
function startTelegramLinkingMonitor(telegramCode) {
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø©
    if (telegramMonitoringInterval) {
        clearInterval(telegramMonitoringInterval);
    }
    
    console.log('ğŸ” Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„ÙƒÙˆØ¯:', telegramCode);
    
    telegramMonitoringInterval = setInterval(async () => {
        try {
            const checkResponse = await fetch(`/check-telegram-status/${telegramCode}`);
            const checkResult = await checkResponse.json();
            
            if (checkResult.success && checkResult.linked) {
                // Ù†Ø¬Ø­ Ø§Ù„Ø±Ø¨Ø·!
                clearInterval(telegramMonitoringInterval);
                telegramMonitoringInterval = null;
                
                console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                showTelegramNotification('âœ… ØªÙ… Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => {
                    window.location.href = '/coins-order';
                }, 1000);
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø¨Ø·:', error);
        }
    }, 3000);
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©
    setTimeout(() => {
        if (telegramMonitoringInterval) {
            clearInterval(telegramMonitoringInterval);
            telegramMonitoringInterval = null;
            console.log('â° Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ù…Ø±Ø§Ù‚Ø¨Ø© Ø±Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…');
        }
    }, 60000);
}

/**
 * âš ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
 */
function handleIncompleteDataError(telegramBtn) {
    const originalContent = telegramBtn.innerHTML;
    
    telegramBtn.innerHTML = `
        <div class="telegram-btn-content">
            <i class="fas fa-exclamation-circle telegram-icon" style="color: #ff4444;"></i>
            <div class="telegram-text">
                <span class="telegram-title">âŒ Ø®Ø·Ø£ - Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</span>
                <span class="telegram-subtitle">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØµØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹</span>
            </div>
        </div>
    `;
    telegramBtn.classList.add('error');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
    showTelegramNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØµØ© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'error');
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        telegramBtn.innerHTML = originalContent;
        telegramBtn.classList.remove('error');
    }, 3000);
}

/**
 * â³ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
 */
function updateTelegramButtonToLoading(telegramBtn) {
    telegramBtn.disabled = true;
    telegramBtn.innerHTML = `
        <div class="telegram-btn-content">
            <i class="fas fa-spinner fa-spin telegram-icon"></i>
            <div class="telegram-text">
                <span class="telegram-title">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</span>
                <span class="telegram-subtitle">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</span>
            </div>
        </div>
    `;
    telegramBtn.classList.add('generating');
}

/**
 * âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
 */
function updateTelegramButtonToSuccess(telegramBtn) {
    telegramBtn.innerHTML = `
        <div class="telegram-btn-content">
            <i class="fas fa-check-circle telegram-icon" style="color: #00d084;"></i>
            <div class="telegram-text">
                <span class="telegram-title">âœ… ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</span>
                <span class="telegram-subtitle">Ø£Ø¯Ø®Ù„ Ù„Ù„Ø¨ÙˆØª ÙˆØ§Ø¶ØºØ· /start</span>
            </div>
        </div>
    `;
    telegramBtn.classList.remove('generating');
    telegramBtn.classList.add('success');
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        const originalContent = `
            <div class="telegram-btn-content">
                <i class="fab fa-telegram telegram-icon"></i>
                <div class="telegram-text">
                    <span class="telegram-title">ğŸ“± Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</span>
                    <span class="telegram-subtitle">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ ÙÙˆØ±ÙŠ ÙˆØ§Ø¯Ø®Ù„ Ù„Ù„Ø¨ÙˆØª</span>
                </div>
            </div>
        `;
        telegramBtn.innerHTML = originalContent;
        telegramBtn.classList.remove('success');
        telegramBtn.disabled = false;
    }, 5000);
}

/**
 * âŒ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø·Ø£ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
 */
function handleTelegramError(telegramBtn, errorMessage) {
    const originalContent = telegramBtn.innerHTML;
    
    telegramBtn.innerHTML = `
        <div class="telegram-btn-content">
            <i class="fas fa-exclamation-triangle telegram-icon" style="color: #ff9000;"></i>
            <div class="telegram-text">
                <span class="telegram-title">âŒ Ø®Ø·Ø£ - Ø§Ø¶ØºØ· Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</span>
                <span class="telegram-subtitle">${errorMessage}</span>
            </div>
        </div>
    `;
    telegramBtn.classList.remove('generating');
    telegramBtn.classList.add('error');
    
    showTelegramNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø²Ø± Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        telegramBtn.innerHTML = originalContent;
        telegramBtn.classList.remove('error');
        telegramBtn.disabled = false;
    }, 3000);
}

/**
 * ğŸ“¢ Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø®Ø§Øµ Ø¨Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
 */
function showTelegramNotification(message, type = 'info') {
    // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    if (typeof showNotification === 'function') {
        showNotification(message, type);
    } else {
        // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ· ÙƒØ¨Ø¯ÙŠÙ„
        console.log(`ğŸ”” ${type.toUpperCase()}: ${message}`);
        alert(message);
    }
}

/**
 * ğŸ”— Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
 */
async function getValidationStatesFromMainSystem() {
    // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    if (typeof validationStates !== 'undefined') {
        return validationStates;
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ØŒ Ù†ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹
    const platform = document.getElementById('platform')?.value || '';
    const whatsapp = document.getElementById('whatsapp')?.value || '';
    const phoneInfo = document.querySelector('.phone-info.success-info');
    const paymentMethod = document.getElementById('payment_method')?.value || '';
    
    return {
        platform: !!platform,
        whatsapp: !!(whatsapp && phoneInfo),
        paymentMethod: !!paymentMethod
    };
}

/**
 * ğŸ”’ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
 */
function getCSRFTokenFromMainSystem() {
    // Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (typeof getCSRFToken === 'function') {
        return getCSRFToken();
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø©
    const token = document.querySelector('meta[name="csrf-token"]') || 
                  document.querySelector('input[name="csrfmiddlewaretoken"]');
    return token ? (token.getAttribute('content') || token.value) : '';
}

/**
 * ğŸŒ Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø³Ø® Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ HTML)
 * Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙØ¹Ø±ÙÙ‘Ø¶ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
 */
window.copyTelegramCodeManual = function(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showTelegramNotification('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }).catch(() => {
            fallbackCopyToClipboard(text);
        });
    } else {
        fallbackCopyToClipboard(text);
    }
};

/**
 * ğŸ”§ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„Ù„ÙˆØ­Ø¯Ø© (ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
 */
export function initializeTelegramModule() {
    console.log('ğŸ¤– ØªÙ… ØªÙ‡ÙŠØ¦Ø© ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø©');
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    const telegramBtn = document.getElementById('telegram-link-btn');
    if (telegramBtn) {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù‚Ø¯Ø§Ù…Ù‰
        const newBtn = telegramBtn.cloneNode(true);
        telegramBtn.parentNode.replaceChild(newBtn, telegramBtn);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        newBtn.addEventListener('click', handleTelegramLink);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
    } else {
        console.warn('âš ï¸ Ø²Ø± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    }
    
    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    if (telegramMonitoringInterval) {
        clearInterval(telegramMonitoringInterval);
        telegramMonitoringInterval = null;
    }
}

// ğŸ“ ØªØ³Ø¬ÙŠÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©
console.log('ğŸ“¦ Telegram Integration Module v2.0.0 - ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
console.log('ğŸ”’ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø¹Ø²ÙˆÙ„Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©');
